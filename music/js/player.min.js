$(function(){function secToMin(e){e=Math.floor(e);var t,i,r,n;return i=(n=Math.floor(e/60))<10?"0"+n:n,t=(r=e%60)<10?"0"+r:r,i+":"+t}function minToSec(e){var t=e.split(":");return 60*t[0]+1*t[1]}function Monitor(){var e={};this.listen=function(t,i){null!=e[t]?e[t].push(i):(e[t]=[],e[t].push(i))},this.trigger=function(t,i){null==e[t]&&(e[t]=[]);for(var r=0;r<e[t].length;r++)if(e[t][r].call(this,i)===!1)return!1}}function setBoxBg(){function e(e){$(document).ready(function(){r[0].src=e,r.load(function(){stackBlurImage("player-box-bg-img","player-box-bg-canvas",playerConfig.theme.bgBlur,!1),t()})})}function t(){var e=n[0].getContext("2d");e.globalCompositeOperation="source-over",e.fillStyle="rgba(0,0,0,0.3)",e.fillRect(0,0,n.width(),n.height());var t=n[0].toDataURL("image/jpg");playerConfig.box.css({background:"url('"+t+"') no-repeat center","background-size":"cover"})}var i,r=p.find("#player-box-bg-img"),n=p.find("#player-box-bg-canvas"),o=/http:\/\//;i=playList[currentSongId].artpic?playList[currentSongId].artpic:"media/"+playList[currentSongId].key+".jpg",o.test(i)?$.post("http://demo.hope13.com/api/img/tobase64",{url:i},function(t,i){"success"==i&&e(t)}):e(i)}function setTheme(){var e=playerConfig.theme;e.cd&&p.find(".art-pic-box,.art-pic-inner").addClass("cdtheme"),e.progressColor&&p.find(".player-progress-inner").css("background",e.progressColor),e.volumeColor&&p.find(".player-volume-current").css("background",e.volumeColor),e.defaultBgImg&&playerConfig.box.css({background:"url('"+e.defaultBgImg+"') no-repeat center","background-size":"cover"})}function initModeSongId(e){for(var t=0;t<playList.length;t++)modeIdList[t]=t;switch(e){case"shuffle":modeIdList.sort(function(){return.5-Math.random()})}}function getModeSongId(e,t){switch(0>e?e=modeIdList.length-1:e%=modeIdList.length,playerConfig.mode){case"shuffle":if("pre"==t){modeId--;var i;return i=0>modeId?modeId=modeIdList.length-1:modeId%modeIdList.length,modeIdList[i]}return modeId++,modeIdList[modeId%modeIdList.length];default:return e}}function getPlayList(){$.ajax({url:"js/playlist1.json",type:"get",dataType:"json",success:function(e){for(var t in e)e.hasOwnProperty(t)&&(playList[playList.length]={key:t,name:e[t].name,artist:e[t].artist,album:e[t].album,mp3:e[t].mp3,aac:e[t].aac,lrc:e[t].lrc,artpic:e[t].artpic});player.init()},error:function(){console.log("请求失败")}})}function getKwSource(){function getKwPlayId(){var e=[];$.getJSON("js/playlist.json",function(t,i){if("success"==i)for(var r in t)e[e.length]=t[r].mid;else getKwPlayId();getKwPlayList(e)})}function getKwPlayList(idList){var playInfo={};$.get("http://mobile.kuwo.cn/mpage/html5/getsongurl",{mid:idList[idListIndex],format:"aac"},function(data,status){"success"==status?(playInfo.aac=data.url,playInfo.mid=idList[idListIndex],$.get("http://mobile.kuwo.cn/mpage/html5/songinfoandlrc",{mid:idList[idListIndex]},function(data,status){"success"==status&&(data=eval("("+data+")"),playInfo.lrc=data.lrclist,playInfo.artist=data.songinfo.artist,playInfo.album=data.songinfo.album,playInfo.artpic="http://img4.kuwo.cn/star/albumcover/"+data.songinfo.artpic,playInfo.duration=data.songinfo.duration,playInfo.name=data.songinfo.name,playList[idListIndex]=playInfo),idListIndex<idList.length-1?(idListIndex++,getKwPlayList(idList)):player.init()})):idListIndex<idList.length-1?(idListIndex++,getKwPlayList(idList)):player.init()},"json")}var idListIndex=0;getKwPlayId()}function formatLrc(e){for(var t,i,r,n=e.split("\n"),o=[],a=0;a<n.length;a++)t=n[a].split("]"),i=minToSec(t[0].replace("[","")),r=$.trim(t[1]),isNaN(i)||""==r||o.push({timeId:i,text:r});return o}function loadLrc(){var e;playList[currentSongId].lrc?(lrc=playList[currentSongId].lrc,showLrc(lrc)):(e="media/"+playList[currentSongId].key+".lrc",$.ajax({url:e,type:"get",dataType:"text",success:function(e){lrc=formatLrc(e),showLrc(lrc)},error:function(){console.log("请求失败")}})),lrcTimeId=0,lrcTemp=void 0,lrcTimeIdTemp=void 0}function showLrc(e){var t=p.find(".player-lrc");if(t.css("top",0),e){for(var i="",r=0;r<e.length;r++)i+="<li class='time-"+r+"'>"+e[r].text+"</li>";t.html(i)}else t.html("<li>暂无歌词</li>");var n=t.height();lrcBarMonitor.trigger("lrcBar",n)}function loadSongInf(){p.find(".art-name").html(playList[currentSongId].name),p.find(".art-singer").html(playList[currentSongId].artist),p.find(".art-album").html(playList[currentSongId].album)}function loadArtPic(){var e;e=playList[currentSongId].artpic?playList[currentSongId].artpic:"media/"+playList[currentSongId].key+".jpg",p.find(".art-pic")[0].src=e}function loadAudio(){var e=playerConfig.mediaType[0],t=playerConfig.mediaType[1],i=p.find(".audio-source-1")[0],r=p.find(".audio-source-2")[0];playList[currentSongId][e]?(i.src=playList[currentSongId][e],r.src=playList[currentSongId][t]?playList[currentSongId][t]:playList[currentSongId][e]):playList[currentSongId][t]?i.src=playList[currentSongId][t]:(i.src="media/"+playList[currentSongId].key+"."+e,r.src="media/"+playList[currentSongId].key+"."+t),audio.load()}function playListListener(){p.find(".player-list").click(function(e){var t=p.find(".playlist-"+currentSongId);"li"==e.target.localName&&(t&&t.removeClass("current"),currentSongId=$(e.target).attr("listid"),player.loadPlayMedia())})}function audioListListener(){var e=p.find(".player-progress").width(),t=p.find(".player-progress-inner"),i=p.find(".time-current"),r=0;$(audio).on("canplay loadedmetadata",function(){p.find(".time-total").html(secToMin(audio.duration)),r=0}).on("timeupdate",function(){showCurrentLrc(audio.currentTime);var r=audio.currentTime/audio.duration;t.width(e*r),i.html(secToMin(audio.currentTime))}).on("ended",function(){switch(playerConfig.mode){case"order":currentSongId!=playList.length-1?p.find(".player-btn-next").trigger("click"):(player.pause(),player.loadPlayMedia(!1));break;case"repeat":player.loadPlayMedia();break;default:p.find(".player-btn-next").trigger("click")}})}function progressListener(){var e=p.find(".player-progress").width();p.find(".player-progress").on("click",function(t){audio.currentTime=t.offsetX/zoom/e*audio.duration})}function volumeListener(){var e=p.find(".player-volume-current");e.width(playerConfig.volume/100*p.find(".player-volume-total").width()),audio.volume=playerConfig.volume/100,p.find(".player-volume-total").click(function(t){audio.volume=t.offsetX/zoom/$(this).width(),e.width(t.offsetX/zoom),audio.muted=!1,p.find(".player-volume-bg").removeClass("mute")}),p.find(".player-volume-bg").click(function(){player.muted(audio.muted?!1:!0)})}function playBtnListener(){var e=p.find(".player-btn-pre"),t=p.find(".player-btn-pp"),i=p.find(".player-btn-next");t.click(function(){audio.paused?player.play():player.pause()}),e.click(function(){p.find(".playlist-"+currentSongId).removeClass("current"),currentSongId=getModeSongId(currentSongId-1,"pre"),player.loadPlayMedia()}),i.click(function(){p.find(".playlist-"+currentSongId).removeClass("current"),currentSongId=getModeSongId(1*currentSongId+1),player.loadPlayMedia()})}function playModeListener(){function e(e){p.find(".player-mode-"+playerConfig.mode).removeClass("current"),e==playerConfig.mode?playerConfig.mode="order":(playerConfig.mode=e,p.find(".player-mode-"+playerConfig.mode).addClass("current"))}p.find(".player-mode").click(function(t){e($(t.target).attr("data")),initModeSongId(playerConfig.mode)})}function lrcBarListener(){var e=p.find(".player-lrc-box").height(),t=createSidebar(p.find(".player-lrc-box"),p.find(".player-lrc"),6,"right");t.height(e/p.find(".player-lrc").height()*e),lrcMonitor.listen("lrc",function(e){var i=p.find(".player-lrc-box").height()-t.height();t.css("top",i*e/(lrc.length-6))}),lrcBarMonitor.listen("lrcBar",function(i){t.css("top","0"),t.height(e/i*e)})}function lrcListBarListener(e){var t=createSidebar(p.find(".player-list-box"),p.find(".player-list"),6,"left");playListbarMonitor.listen("playList",function(i){t.height(e/i*e)})}function createSidebar(e,t,i,r){function n(e,i,r){l.css("top",e),a=Math.floor(e/i*r/28),t.css({top:"-"+28*a+"px"})}var o={position:"absolute",top:0,background:"rgba(255,255,255,.1)","border-radius":i/2+"px",cursor:"pointer",transition:"top 1s"};o[r]=0;var a,l=$("<div>").width(i).css(o);return l.on("mouseover",function(){$(this).css({background:"rgba(255,255,255,.5)"})}).on("mouseout",function(){$(this).css({background:"rgba(255,255,255,.1)"})}).on("mousedown",function(i){$(this).off("mouseout"),$(this).css({background:"rgba(255,255,255,.5)",transition:"top 0s"});var r=i.clientY,o=$(this).css("top").replace("px",""),a=t.height();$(document).on("mousemove",function(t){var i=e.height()-l.height(),d=1*o+t.clientY-r;0>d?d=0:d>i&&(d=i),l.css("top",d+"px"),n(d,i,a-i)})}).appendTo(e),$(document).on("mouseup",function(){$(this).off("mousemove"),l.css({background:"rgba(255,255,255,.1)",transition:"top 1s"}),l.on("mouseout",function(){l.css({background:"rgba(255,255,255,.1)"})})}),e.on("mousewheel DOMMouseScroll",function(i,r){var o=e.height()-l.height(),a=r;if(a)switch(a){case"up":a=-1;break;case"down":a=1}else a=i.originalEvent.wheelDelta&&(i.originalEvent.wheelDelta>0?1:-1)||i.originalEvent.detail&&(i.originalEvent.detail>0?-1:1);var d,c=t.height(),s=l.css("top").replace("px","");a>0?d=s-o/4:0>a&&(d=1*s+o/4),0>d?d=0:d>o&&(d=o),l.css("top",d+"px"),n(d,o,c-o)}),l}function showCurrentLrc(e){if(lrcTimeId<lrc.length&&e>lrc[lrcTimeId].timeId){for(;lrcTimeId<lrc.length&&e>lrc[lrcTimeId].timeId;)lrcTimeId++;lrcTimeId--}else if(lrcTimeId>=1&&e<lrc[lrcTimeId].timeId){for(lrcTimeId=0;e>lrc[lrcTimeId].timeId;)lrcTimeId++;lrcTimeId--}lrcTimeId!=lrcTimeIdTemp&&(changeLrcTop(lrcTimeId),lrcTemp&&lrcTemp.removeClass("current"),lrcTemp=p.find(".time-"+lrcTimeId).addClass("current"),lrcTimeIdTemp=lrcTimeId)}function changeLrcTop(e){e>6?(p.find(".player-lrc").css({top:"-"+28*(lrcTimeId-6)+"px"}),lrcMonitor.trigger("lrc",lrcTimeId-6)):p.find(".player-lrc").css({top:"0"})}function listener(){playListListener(),progressListener(),audioListListener(),volumeListener(),playBtnListener(),playModeListener(),lrcBarListener()}function setBgSize(){playerConfig.box.height($(window).height()).width($(".mid-col").width())}function windowSizeListerer(){var e=p.width(),t=p.height();setBgSize(),changePlayerSize(playerConfig.box.width(),playerConfig.box.height(),e,t),p.css({top:(playerConfig.box.height()-p.height()*zoom)/2+"px"}),$(window).on("resize",function(){setBgSize(),changePlayerSize(playerConfig.box.width(),playerConfig.box.height(),e,t),p.css({top:(playerConfig.box.height()-p.height()*zoom)/2+"px"})})}function changePlayerSize(e,t,i,r){var n=e/i,o=t/r;zoom=Math.min(n,o)<1?Math.min(n,o):1,p.css({zoom:zoom})}function loadErrorListener(){var e=p.find(".audio-source-1"),t=p.find(".audio-source-2");e.on("error",function(){t.on("error",function(){$.get("http://mobile.kuwo.cn/mpage/html5/getsongurl",{mid:playList[currentSongId].mid,format:"aac"},function(e,t){"success"==t&&(playList[currentSongId].aac=e.url,player.loadPlayMedia())},"json")})})}function init(){getKwSource(),setTheme(),windowSizeListerer(),loadErrorListener()}var playerConfig={autoplay:!1,defaultId:0,mode:"order",volume:75,mediaType:["aac","mp3"],box:$("#post-music"),theme:{cd:!1,progressColor:!1,volumeColor:!1,defaultBgImg:!1,bgBlur:10}},playList=[],modeIdList=[],modeId=playerConfig.defaultId,p=$("#player"),currentSongId=playerConfig.defaultId,audio=p.find(".audio")[0],lrc,zoom=1,lrcMonitor=new Monitor,lrcBarMonitor=new Monitor,playListbarMonitor=new Monitor,lrcTimeId=0,lrcTemp=void 0,lrcTimeIdTemp=void 0,player={play:function(){audio.play(),p.find(".player-btn-pp").css({background:"url('images/stop.png') no-repeat center","background-size":"80%",opacity:".5"})},pause:function(){audio.pause(),p.find(".player-btn-pp").css({background:"url('images/play.png') no-repeat center","background-size":"80%",opacity:".5"})},muted:function(e){e?(audio.muted=!0,p.find(".player-volume-bg").addClass("mute")):(audio.muted=!1,p.find(".player-volume-bg").removeClass("mute"))},loadPlayList:function(){for(var e="",t=0;t<playList.length;t++)e+="<li class='playlist-"+t+"' listid='"+t+"'>"+playList[t].artist+" - "+playList[t].name+"</li>";p.find(".player-list").html(e);var i=p.find(".player-list-box").height(),r=p.find(".player-list").height();r>i&&(lrcListBarListener(i,r),playListbarMonitor.trigger("playList",p.find(".player-list").height()))},loadPlayMedia:function(e){loadLrc(),loadSongInf(),loadArtPic(),loadAudio(),p.find(".playlist-"+currentSongId).addClass("current"),(void 0===e||e===!0)&&player.play(),setBoxBg()},init:function(){player.loadPlayList(),player.loadPlayMedia(playerConfig.autoplay),initModeSongId(playerConfig.mode),listener()}};init()});